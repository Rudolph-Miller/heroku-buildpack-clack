#!/usr/bin/env bash

# bin/compile <build-dir> <cache-dir> <env-dir>

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

TMP_DIR=/tmp
USR_DIR=$BUILD_DIR/usr
CL_DIR=$BUILD_DIR/common-lisp

ROSWELL_DIR=$CL_DIR/roswell

LIBEV_VERSION=4.19

LIBEV_DIR=$TMP_DIR/libev-$LIBEV_VERSION

ROSWELL_REPO=https://github.com/snmsts/roswell.git
ROSWELL_BR=master
LIBEV_URL=http://dist.schmorp.de/libev/libev-$LIBEV_VERSION.tar.gz

ROS_COMMAND=$USR_DIR/bin/ros

mkdir -p $USR_DIR
mkdir -p $USR_DIR/bin
mkdir -p $USR_DIR/lib
mkdir -p $CL_DIR

cd $CL_DIR
git clone -b $ROSWELL_BR $ROSWELL_REPO
cd $ROSWELL_DIR
sh bootstrap
./configure --prefix=$USR_DIR
make
make install
$ROS_COMMAND setup
$ROS_COMMAND install sbcl-bin

cd $TMP_DIR
curl $LIBEV_URL | tar zxv
cd $LIBEV_DIR
./configure --enable-shared --prefix=$USR_DIR
make
make install

mkdir -p $BUILD_DIR/.profile.d
cat << EOF >> $BUILD_DIR/.profile.d/common.sh
PATH=$PATH:/app/usr/bin
LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/app/usr/lib
CL_SOURCE_REGISTRY=/app
ln -s /app $BUILD_DIR
EOF
