#!/usr/bin/env bash

# bin/compile <build-dir> <cache-dir> <env-dir>

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

TMP_DIR=/tmp
USR_DIR=$BUILD_DIR/usr
CL_DIR=$BUILD_DIR/common-lisp

ROSWELL_DIR=$CL_DIR/roswell
QLOT_DIR=$CL_DIR/qlot
CLACK_DIR=$CL_DIR/clack

LIBEV_VERSION=4.19

LIBEV_DIR=$TMP_DIR/libev-$LIBEV_VERSION

ROSWELL_REPO=https://github.com/snmsts/roswell.git
ROSWELL_BR=master
QLOT_REPO=https://github.com/fukamachi/qlot.git
QLOT_BR=master
CLACK_REPO=https://github.com/fukamachi/clack.git
CLACK_BR=master
LIBEV_URL=http://dist.schmorp.de/libev/libev-$LIBEV_VERSION.tar.gz

ROS_COMMAND=$USR_DIR/bin/ros
QLOT_COMMAND=$QLOT_DIR/bin/qlot
CLACKUP_COMMAND=$CLACK_DIR/bin/clackup

if [ ! -d $USR_DIR ]; then
    mkdir -p $USR_DIR
    mkdir -p $USR_DIR/bin
    mkdir -p $USR_DIR/lib
fi

if [ ! -d $CL_DIR ]; then
    mkdir -p $CL_DIR
fi

if [ ! -f $ROS_COMMAND ]; then
    cd $CL_DIR
    git clone -b $ROSWELL_BR $ROSWELL_REPO
    cd $ROSWELL_DIR
    sh bootstrap
    ./configure --prefix=$USR_DIR
    make
    make install
fi
$ROS_COMMAND setup
$ROS_COMMAND install sbcl-bin

if [ ! -f $QLOT_COMMAND ]; then
    cd $CL_DIR
    git clone -b $QLOT_BR $QLOT_REPO
    ln -fns $QLOT_DIR/bin/qlot $QLOT_COMMAND
fi

if [ ! -f $CLACKUP_COMMAND ]; then
    cd $CL_DIR
    git clone -b $CLACK_BR $CLACK_REPO
    ln -fns $CLACK_DIR/bin/qlot $CLACKUP_COMMAND
fi

if [ ! -f $USR_DIR/lib/libev.so ]; then
    cd $TMP_DIR
    curl $LIBEV_URL | tar zxv
    cd $LIBEV_DIR
    ./configure --enable-shared --prefix=$USR_DIR
    make
    make install
fi
